L.interpolatePosition=function(e,t,n,r){var i=r/n;return i=i>0?i:0,i=i>1?1:i,L.latLng(e.lat+i*(t.lat-e.lat),e.lng+i*(t.lng-e.lng))},L.Marker.MovingMarker=L.Marker.extend({statics:{notStartedState:0,endedState:1,pausedState:2,runState:3},options:{autostart:!1,loop:!1},initialize:function(e,t,n){L.Marker.prototype.initialize.call(this,e[0],n),this._latlngs=e.map(function(e,t){return L.latLng(e)}),t instanceof Array?this._durations=t:this._durations=this._createDurations(this._latlngs,t),this._currentDuration=0,this._currentIndex=0,this._state=L.Marker.MovingMarker.notStartedState,this._startTime=0,this._startTimeStamp=0,this._pauseStartTime=0,this._animId=0,this._animRequested=!1,this._currentLine=[],this._stations={}},isRunning:function(){return this._state===L.Marker.MovingMarker.runState},isEnded:function(){return this._state===L.Marker.MovingMarker.endedState},isStarted:function(){return this._state!==L.Marker.MovingMarker.notStartedState},isPaused:function(){return this._state===L.Marker.MovingMarker.pausedState},start:function(){this.isRunning()||(this.isPaused()?this.resume():(this._loadLine(0),this._startAnimation(),this.fire(`start`)))},resume:function(){this.isPaused()&&(this._currentLine[0]=this.getLatLng(),this._currentDuration-=this._pauseStartTime-this._startTime,this._startAnimation())},pause:function(){this.isRunning()&&(this._pauseStartTime=Date.now(),this._state=L.Marker.MovingMarker.pausedState,this._stopAnimation(),this._updatePosition())},stop:function(e){this.isEnded()||(this._stopAnimation(),e===void 0&&(e=0,this._updatePosition()),this._state=L.Marker.MovingMarker.endedState,this.fire(`end`,{elapsedTime:e}))},addLatLng:function(e,t){this._latlngs.push(L.latLng(e)),this._durations.push(t)},moveTo:function(e,t){this._stopAnimation(),this._latlngs=[this.getLatLng(),L.latLng(e)],this._durations=[t],this._state=L.Marker.MovingMarker.notStartedState,this.start(),this.options.loop=!1},addStation:function(e,t){e>this._latlngs.length-2||e<1||(this._stations[e]=t)},onAdd:function(e){if(L.Marker.prototype.onAdd.call(this,e),this.options.autostart&&!this.isStarted()){this.start();return}this.isRunning()&&this._resumeAnimation()},onRemove:function(e){L.Marker.prototype.onRemove.call(this,e),this._stopAnimation()},_createDurations:function(e,t){for(var n=e.length-1,r=[],i=0,a=0,o=0;o<n;o++)a=e[o+1].distanceTo(e[o]),r.push(a),i+=a;var s=t/i,c=[];for(o=0;o<r.length;o++)c.push(r[o]*s);return c},_startAnimation:function(){this._state=L.Marker.MovingMarker.runState,this._animId=L.Util.requestAnimFrame(function(e){this._startTime=Date.now(),this._startTimeStamp=e,this._animate(e)},this,!0),this._animRequested=!0},_resumeAnimation:function(){this._animRequested||(this._animRequested=!0,this._animId=L.Util.requestAnimFrame(function(e){this._animate(e)},this,!0))},_stopAnimation:function(){this._animRequested&&=(L.Util.cancelAnimFrame(this._animId),!1)},_updatePosition:function(){var e=Date.now()-this._startTime;this._animate(this._startTimeStamp+e,!0)},_loadLine:function(e){this._currentIndex=e,this._currentDuration=this._durations[e],this._currentLine=this._latlngs.slice(e,e+2)},_updateLine:function(e){var t=e-this._startTimeStamp;if(t<=this._currentDuration)return t;for(var n=this._currentIndex,r=this._currentDuration,i;t>r;){if(t-=r,i=this._stations[n+1],i!==void 0){if(t<i)return this.setLatLng(this._latlngs[n+1]),null;t-=i}if(n++,n>=this._latlngs.length-1)if(this.options.loop)n=0,this.fire(`loop`,{elapsedTime:t});else return this.setLatLng(this._latlngs[this._latlngs.length-1]),this.stop(t),null;r=this._durations[n]}return this._loadLine(n),this._startTimeStamp=e-t,this._startTime=Date.now()-t,t},_animate:function(e,t){this._animRequested=!1;var n=this._updateLine(e);if(!this.isEnded()){if(n!=null){var r=L.interpolatePosition(this._currentLine[0],this._currentLine[1],this._currentDuration,n);this.setLatLng(r)}t||(this._animId=L.Util.requestAnimFrame(this._animate,this,!1),this._animRequested=!0)}}}),L.Marker.movingMarker=function(e,t,n){return new L.Marker.MovingMarker(e,t,n)};